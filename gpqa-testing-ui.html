<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPQA Testing UI - Full Observability</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0a;
            color: #e0e0e0;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header p {
            color: #a0a0a0;
            font-size: 1.1em;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 20px;
            height: calc(100vh - 200px);
        }

        .sidebar {
            background: #1a1a1a;
            border-radius: 12px;
            padding: 20px;
            overflow-y: auto;
            border: 1px solid #333;
        }

        .question-selector {
            margin-bottom: 20px;
        }

        .question-selector h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .question-list {
            list-style: none;
        }

        .question-item {
            background: #252525;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid #333;
        }

        .question-item:hover {
            background: #2a2a2a;
            border-color: #667eea;
            transform: translateX(5px);
        }

        .question-item.active {
            background: #2d1b69;
            border-color: #667eea;
        }

        .question-item .q-number {
            color: #667eea;
            font-weight: bold;
            margin-right: 8px;
        }

        .question-item .q-category {
            font-size: 0.85em;
            color: #888;
            display: block;
            margin-top: 4px;
        }

        .controls {
            background: #1a1a1a;
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
            border: 1px solid #333;
        }

        .controls h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .control-group {
            margin-bottom: 15px;
        }

        .control-group label {
            display: block;
            margin-bottom: 5px;
            color: #a0a0a0;
            font-size: 0.9em;
        }

        .control-group input, .control-group select {
            width: 100%;
            padding: 8px 12px;
            background: #252525;
            border: 1px solid #333;
            border-radius: 6px;
            color: #e0e0e0;
            font-size: 0.95em;
        }

        .control-group input:focus, .control-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .main-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .question-display {
            background: #1a1a1a;
            padding: 25px;
            border-radius: 12px;
            border: 1px solid #333;
            max-height: 400px;
            overflow-y: auto;
        }

        .question-display h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .question-text {
            background: #252525;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            line-height: 1.8;
        }

        .options-list {
            list-style: none;
        }

        .option-item {
            background: #252525;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border: 1px solid #333;
            display: flex;
            align-items: flex-start;
        }

        .option-letter {
            color: #667eea;
            font-weight: bold;
            margin-right: 12px;
            font-size: 1.1em;
        }

        .option-item.correct {
            border-color: #4caf50;
            background: rgba(76, 175, 80, 0.1);
        }

        .logs-section {
            background: #1a1a1a;
            border-radius: 12px;
            border: 1px solid #333;
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .logs-tabs {
            display: flex;
            background: #252525;
            border-radius: 12px 12px 0 0;
            overflow: hidden;
        }

        .tab {
            padding: 12px 24px;
            cursor: pointer;
            background: transparent;
            border: none;
            color: #888;
            font-size: 0.95em;
            transition: all 0.2s;
            flex: 1;
            border-right: 1px solid #333;
        }

        .tab:last-child {
            border-right: none;
        }

        .tab:hover {
            background: #2a2a2a;
            color: #e0e0e0;
        }

        .tab.active {
            background: #2d1b69;
            color: #fff;
        }

        .log-content {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9em;
            line-height: 1.6;
            max-height: none;
            word-wrap: break-word;
            white-space: pre-wrap;
        }

        .log-entry {
            margin-bottom: 12px;
            padding: 10px;
            background: #252525;
            border-radius: 6px;
            border-left: 3px solid #333;
        }

        .log-entry.info {
            border-left-color: #2196f3;
        }

        .log-entry.success {
            border-left-color: #4caf50;
        }

        .log-entry.warning {
            border-left-color: #ff9800;
        }

        .log-entry.error {
            border-left-color: #f44336;
        }

        .log-timestamp {
            color: #666;
            font-size: 0.85em;
            margin-right: 10px;
        }

        .test-button {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 20px;
        }

        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
        }

        .test-button:disabled {
            background: #444;
            cursor: not-allowed;
            transform: none;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: #252525;
            border-radius: 20px;
            font-size: 0.85em;
            margin-top: 10px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #666;
            animation: pulse 2s infinite;
        }

        .status-dot.active {
            background: #4caf50;
        }

        .status-dot.processing {
            background: #ff9800;
        }

        .status-dot.error {
            background: #f44336;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .thinking-display {
            background: #1e1e2e;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            border: 1px solid #444;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9em;
            max-height: none;
            overflow-y: visible;
        }

        .response-metrics {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .metric-card {
            background: #252525;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #333;
        }

        .metric-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #667eea;
        }

        .metric-label {
            font-size: 0.85em;
            color: #888;
            margin-top: 5px;
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        ::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>GPQA Testing Interface</h1>
            <p>Full observability for model responses, thinking process, and system logs</p>
        </div>

        <div class="main-grid">
            <!-- Sidebar -->
            <div class="sidebar">
                <div class="question-selector">
                    <h3>Select Question</h3>
                    <ul class="question-list" id="questionList">
                        <!-- Questions will be populated here -->
                    </ul>
                </div>

                <div class="controls">
                    <h3>Test Configuration</h3>
                    
                    <div class="control-group">
                        <label for="model">Model</label>
                        <select id="model">
                            <option value="google/gemini-2.5-flash-lite">Gemini 2.5 Flash Lite</option>
                            <option value="z-ai/glm-4.5-air:free">GLM-4.5-air (Free)</option>
                            <option value="anthropic/claude-3-opus">Claude 3 Opus</option>
                        </select>
                    </div>

                    <div class="control-group">
                        <label for="timeout">Timeout (seconds)</label>
                        <input type="number" id="timeout" value="120" min="10" max="600">
                    </div>

                    <div class="control-group">
                        <label for="maxTokens">Max Tokens</label>
                        <input type="number" id="maxTokens" value="8000" min="100" max="32000">
                    </div>

                    <div class="control-group">
                        <label for="routingMode">Routing Mode</label>
                        <select id="routingMode">
                            <option value="workflow" selected>Workflow Engine (Full System)</option>
                            <option value="direct">Direct (No routing)</option>
                            <option value="math">Math Agent Only</option>
                        </select>
                    </div>

                    <button class="test-button" id="testButton">Run Test</button>
                    
                    <div class="status-indicator">
                        <span class="status-dot" id="statusDot"></span>
                        <span id="statusText">Ready</span>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="main-content">
                <!-- Question Display -->
                <div class="question-display">
                    <h3>Question</h3>
                    <div id="questionContent">
                        <p style="color: #666;">Select a question to begin</p>
                    </div>
                </div>

                <!-- Logs Section -->
                <div class="logs-section">
                    <div class="logs-tabs">
                        <button class="tab active" data-tab="response">Model Response</button>
                        <button class="tab" data-tab="thinking">Thinking Process</button>
                        <button class="tab" data-tab="system">System Logs</button>
                        <button class="tab" data-tab="raw">Raw JSON</button>
                    </div>
                    
                    <div class="log-content" id="logContent">
                        <div class="log-entry info">
                            <span class="log-timestamp">Ready</span>
                            Select a question and click "Run Test" to see the model's response
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // GPQA Questions Data
        const gpqaQuestions = [
            {
                id: "gpqa-1",
                category: "Molecular Biology",
                question: "A large gene has dozens of exons, of which the central ones code for folded triple helical repeats that connect the cytoskeleton with sarcolemma and extracellular space. Each exon usually codes for one folded triple alpha helix. The most common mutations of the gene are central exon deletions that create out-of-frame peptides and progressive degenerative organ waste. A solution is to deliver a Morpholino that recognizes the 5' end of the out-of-frame exon in pre-mRNA. The molecule prevents binding of the spliceosome and creates exon skipping and in-frame joining. Several missing exons are well tolerated by an organism. Which structure below is not involved in the proposed therapy?",
                options: {
                    A: "antisense",
                    B: "polyA tail",
                    C: "lariat",
                    D: "R-loops"
                },
                correct_answer: "D"
            },
            {
                id: "gpqa-2",
                category: "Physics (general)",
                question: "Two quantum states with energies E1 and E2 have a lifetime of 10^-9 sec and 10^-8 sec, respectively. We want to clearly distinguish these two energy levels. Which one of the following options could be their energy difference so that they can be clearly resolved?",
                options: {
                    A: "10^-9 eV",
                    B: "10^-8 eV",
                    C: "10^-11 eV",
                    D: "10^-4 eV"
                },
                correct_answer: "D"
            },
            {
                id: "gpqa-3",
                category: "Organic Chemistry",
                question: "trans-cinnamaldehyde was treated with methylmagnesium bromide, forming product 1. 1 was treated with pyridinium chlorochromate, forming product 2. 3 was treated with (dimethyl(oxo)-l6-sulfaneylidene)methane in DMSO at elevated temperature, forming product 3. how many carbon atoms are there in product 3?",
                options: {
                    A: "11",
                    B: "10",
                    C: "12",
                    D: "14"
                },
                correct_answer: "A"
            },
            {
                id: "gpqa-4",
                category: "Molecular Biology",
                question: "To investigate the causes of a complex genetic disease, you culture patient cells and carry out DNA sequencing to detect mutations in candidate genes. This revealed a mutation in the gene HOXB2 that is only present in the patient cells and not the healthy controls. To learn more about the role of this mutation in the disease, you want to explore the relationship between chromatin structure and gene expression in patient cells and compare your results to healthy cells. Which of the following combinations of methods would provide you with results that would help your investigations?",
                options: {
                    A: "CHIP-seq, RNA-seq, and qRT PCR",
                    B: "CHIP-seq, chromosome conformation capture, and qRT-PCR",
                    C: "ChIP-seq and RNA-seq",
                    D: "Chromosome conformation capture and RNA-seq"
                },
                correct_answer: "B"
            },
            {
                id: "gpqa-5",
                category: "Quantum Mechanics",
                question: "A spin-half particle is in a linear superposition 0.5|up‚ü©+‚àö3/2|down‚ü© of its spin-up and spin-down states. If |up‚ü© and |down‚ü© are the eigenstates of œÉ_z , then what is the expectation value up to one decimal place, of the operator 10œÉ_z+5œÉ_x ? Here, symbols have their usual meanings",
                options: {
                    A: "-0.7",
                    B: "1.65",
                    C: "0.85",
                    D: "-1.4"
                },
                correct_answer: "A"
            },
            {
                id: "gpqa-6",
                category: "Chemistry (general)",
                question: "A coating is applied to a substrate resulting in a perfectly smooth surface. The measured contact angles of this smooth coating are 132¬∞ and 102¬∞ for water and hexadecane respectively. The coating formulation is then modified and when now applied to the same type of substrate, a rough surface is produced. When a droplet of water or oil sits on the rough surface, the wettability of the surface can now be described by the Cassie-Baxter state. The water contact angle on the rough surface is now 148¬∞. What would be the best estimate of the contact angle of a droplet of octane on the rough surface?",
                options: {
                    A: "139¬∞",
                    B: "124¬∞",
                    C: "134¬∞",
                    D: "129¬∞"
                },
                correct_answer: "B"
            },
            {
                id: "gpqa-7",
                category: "Genetics",
                question: "Scientist 1 is studying linkage maps in Drosophila. Specifically, Scientist 1 is working out the linkage between 3 genes in one cross, also known as a three-point testcross. The genes under study are V, CV, and CT. To obtain the required information a trihybrid female and a tester male (triple recessive male) are crossed. Analyzing the information from this cross, the genetic mapping and the genetic map units (m.u.) read as follows: V - - CT - CV V -> CV: 18.5% V -> CT: 13.2% CV -> CT: 6.4 % Scientist 1 questioned the data, asking, \"Why was the addition of V -> CT and CV -> CT (13.2% + 6.4%) greater than the m.u. for V -> CV (18.5%)?",
                options: {
                    A: "Recombinant interference",
                    B: "The gene order was reversed",
                    C: "Erred loci placement",
                    D: "A double crossover event"
                },
                correct_answer: "D"
            },
            {
                id: "gpqa-8",
                category: "Electromagnetism and Photonics",
                question: "In a parallel universe where a magnet can have an isolated North or South pole, Maxwell's equations look different. But, specifically, which of those equations are different?",
                options: {
                    A: "The one related to the divergence of the magnetic field.",
                    B: "The ones related to the divergence and the curl of the magnetic field.",
                    C: "The ones related to the circulation of the electric field and the divergence of the magnetic field.",
                    D: "The one related to the circulation of the magnetic field and the flux of the electric field."
                },
                correct_answer: "C"
            },
            {
                id: "gpqa-9",
                category: "Organic Chemistry",
                question: "In a cycloaddition reaction, two œÄ systems combine to form a single-ring structure. These reactions can occur under two conditions including thermal and photochemical. These reactions follow the general mechanism given below. Ethene + ethene (Heat) ----- cyclobutane Mention the cycloaddition products of the following reactions. (E)-penta-1,3-diene + acrylonitrile ---> A cyclopentadiene + methyl acrylate (Heat) ---> B",
                options: {
                    A: "A = 5-methylcyclohex-3-ene-1-carbonitrile, B = methyl (1R,2R,4R)-bicyclo[2.2.1]hept-5-ene-2-carboxylate",
                    B: "A = cyclohexa-2,4-diene-1-carbonitrile, B = methyl (1R,2R,4R)-bicyclo[2.2.1]hept-5-ene-2-carboxylate",
                    C: "A = 5-methylcyclohex-3-ene-1-carbonitrile, B = methyl (1R,2S,4R)-bicyclo[2.2.1]hept-5-ene-2-carboxylate",
                    D: "A = cyclohexa-2,4-diene-1-carbonitrile, B = methyl (1R,2S,4R)-bicyclo[2.2.1]hept-5-ene-2-carboxylate"
                },
                correct_answer: "A"
            },
            {
                id: "gpqa-10",
                category: "Genetics",
                question: "You perform a high-throughput experiment on white lupine to find genes contributing to resistance to the fungal disease anthracnose. As a result, you receive three candidate genes of unknown function ‚Äì G1, G2, and G3. You create three knock-out mutants, g1, g2, and g3, and a set of double-mutants, g1g2, g1g3, and g2g3. You know that at least one of these genes is a transcription factor acting upstream of (an)other gene(s). You start to test those mutant plants: do they have a higher sensitivity to anthracnose than the wild-type because they cannot produce certain gene products? After tests with the pathogen, you receive the following results where 100% is the level of resistance to the pathogen in control; 50% is half of the control's resistance; 25% is a quarter of the control's resistance; 0% ‚Äí all plants show signs of infection: - resistance of g1: 75% of control - resistance of g2: 0% from control - resistance of g3: 50% from control -resistance of g1g3: 10% from control - resistance of g2g3: 0% from control - resistance of g1g2: 0% from control Which conclusion regarding those genes' interaction can you draw from this experiment?",
                options: {
                    A: "G1 is a transcription factor, G2 and G3 show pleiotropy, G2 is epistatic towards G1",
                    B: "G2 is a transcription factor, G1 and G3 has the same promoter, G3 is epistatic towards G1",
                    C: "G2 is a transcription factor, G1 and G3 show pleiotropy, G1 is epistatic towards G3",
                    D: "G2 is a transcription factor, G1 and G3 show gene redundancy, G1 is epistatic towards G3"
                },
                correct_answer: "D"
            }
        ];

        // State management
        let selectedQuestion = null;
        let currentTab = 'response';
        let testResults = {};

        // Initialize UI
        function initializeUI() {
            renderQuestionList();
            setupEventListeners();
        }

        // Render question list
        function renderQuestionList() {
            const questionList = document.getElementById('questionList');
            questionList.innerHTML = gpqaQuestions.map((q, index) => `
                <li class="question-item" data-id="${q.id}" data-index="${index}">
                    <span class="q-number">Q${index + 1}</span>
                    ${q.category}
                    <span class="q-category">Expected: ${q.correct_answer}</span>
                </li>
            `).join('');
        }

        // Setup event listeners
        function setupEventListeners() {
            // Question selection
            document.getElementById('questionList').addEventListener('click', (e) => {
                const item = e.target.closest('.question-item');
                if (item) {
                    selectQuestion(parseInt(item.dataset.index));
                }
            });

            // Tab switching
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    switchTab(tab.dataset.tab);
                });
            });

            // Test button
            document.getElementById('testButton').addEventListener('click', runTest);
        }

        // Select question
        function selectQuestion(index) {
            selectedQuestion = gpqaQuestions[index];
            
            // Update UI
            document.querySelectorAll('.question-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-index="${index}"]`).classList.add('active');

            // Display question
            displayQuestion();
        }

        // Display selected question
        function displayQuestion() {
            if (!selectedQuestion) return;

            const content = `
                <div class="question-text">${selectedQuestion.question}</div>
                <ul class="options-list">
                    ${Object.entries(selectedQuestion.options).map(([letter, text]) => `
                        <li class="option-item ${letter === selectedQuestion.correct_answer ? 'correct' : ''}">
                            <span class="option-letter">${letter})</span>
                            <span>${text}</span>
                        </li>
                    `).join('')}
                </ul>
            `;
            
            document.getElementById('questionContent').innerHTML = content;
        }

        // Switch tabs
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(t => {
                t.classList.toggle('active', t.dataset.tab === tab);
            });
            displayLogContent();
        }

        // Display log content based on current tab
        function displayLogContent() {
            const logContent = document.getElementById('logContent');
            
            if (!testResults[selectedQuestion?.id]) {
                logContent.innerHTML = `
                    <div class="log-entry info">
                        <span class="log-timestamp">No data</span>
                        Run a test to see results
                    </div>
                `;
                return;
            }

            const result = testResults[selectedQuestion.id];
            
            switch (currentTab) {
                case 'response':
                    displayResponse(result);
                    break;
                case 'thinking':
                    displayThinking(result);
                    break;
                case 'system':
                    displaySystemLogs(result);
                    break;
                case 'raw':
                    displayRawJSON(result);
                    break;
            }
        }

        // Display model response
        function displayResponse(result) {
            const logContent = document.getElementById('logContent');
            logContent.innerHTML = `
                <div class="response-metrics">
                    <div class="metric-card">
                        <div class="metric-value">${result.responseTime || 'N/A'}</div>
                        <div class="metric-label">Response Time (ms)</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${result.tokensUsed || 'N/A'}</div>
                        <div class="metric-label">Tokens Used</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${result.modelAnswer || 'N/A'}</div>
                        <div class="metric-label">Model Answer</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${result.correct ? '‚úì' : '‚úó'}</div>
                        <div class="metric-label">Correct</div>
                    </div>
                </div>
                <div class="thinking-display">
                    <h4 style="color: #667eea; margin-bottom: 15px;">Full Response:</h4>
                    ${escapeHtml(result.response || 'No response available')}
                </div>
            `;
        }

        // Display thinking process
        function displayThinking(result) {
            const logContent = document.getElementById('logContent');
            const thinking = result.thinking || [];
            
            logContent.innerHTML = `
                <h4 style="color: #667eea; margin-bottom: 15px;">Model Thinking Process:</h4>
                ${thinking.length ? thinking.map((thought, index) => `
                    <div class="log-entry info">
                        <span class="log-timestamp">Step ${index + 1}</span>
                        ${escapeHtml(thought)}
                    </div>
                `).join('') : '<div class="log-entry">No thinking data available</div>'}
            `;
        }

        // Display system logs
        function displaySystemLogs(result) {
            const logContent = document.getElementById('logContent');
            const logs = result.systemLogs || [];
            
            logContent.innerHTML = logs.map(log => `
                <div class="log-entry ${log.level}">
                    <span class="log-timestamp">${new Date(log.timestamp).toLocaleTimeString()}</span>
                    <strong>${log.type}:</strong> ${escapeHtml(log.message)}
                </div>
            `).join('') || '<div class="log-entry">No system logs available</div>';
        }

        // Display raw JSON
        function displayRawJSON(result) {
            const logContent = document.getElementById('logContent');
            logContent.innerHTML = `
                <pre style="white-space: pre-wrap; color: #a0a0a0;">${JSON.stringify(result, null, 2)}</pre>
            `;
        }

        // Run test with streaming
        async function runTest() {
            console.log('Run test clicked');
            
            if (!selectedQuestion) {
                alert('Please select a question first');
                return;
            }

            const testButton = document.getElementById('testButton');
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            
            console.log('Selected question:', selectedQuestion);
            
            // Update UI state
            testButton.disabled = true;
            statusDot.className = 'status-dot processing';
            statusText.textContent = 'Processing...';

            // Initialize result object
            const currentResult = {
                questionId: selectedQuestion.id,
                systemLogs: [],
                thinking: [],
                response: '',
                responseTime: null,
                tokensUsed: null
            };
            testResults[selectedQuestion.id] = currentResult;

            // Clear previous results and show live content
            const logContent = document.getElementById('logContent');
            logContent.innerHTML = `
                <div class="log-entry info">
                    <span class="log-timestamp">${new Date().toLocaleTimeString()}</span>
                    Starting test for Question ${gpqaQuestions.indexOf(selectedQuestion) + 1}...
                </div>
                <div id="liveUpdates" style="margin-top: 20px;">
                    <div class="thinking-display" id="liveContent">
                        <h4 style="color: #667eea; margin-bottom: 15px;">Live Response:</h4>
                        <div id="streamingContent"></div>
                    </div>
                </div>
            `;

            try {
                // Prepare query
                const query = `${selectedQuestion.question}\n\n${Object.entries(selectedQuestion.options)
                    .map(([letter, text]) => `(${letter}) ${text}`)
                    .join('\n')}`;

                // Get configuration
                const config = {
                    model: document.getElementById('model').value,
                    timeout: parseInt(document.getElementById('timeout').value) * 1000,
                    maxTokens: parseInt(document.getElementById('maxTokens').value),
                    routingMode: document.getElementById('routingMode').value
                };

                console.log('Test configuration:', config);
                console.log('Making API call to /api/test-gpqa...');

                // Make initial API call to get requestId
                const response = await fetch('/api/test-gpqa', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        question: selectedQuestion,
                        query: query,
                        config: config
                    })
                });

                const { requestId } = await response.json();
                console.log('Got requestId:', requestId);
                
                // Connect to SSE stream
                const eventSource = new EventSource(`/api/test-gpqa-stream/${requestId}`);
                const streamingContent = document.getElementById('streamingContent');
                
                eventSource.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    console.log('Stream event:', data.type, data);
                    
                    switch (data.type) {
                        case 'connected':
                            streamingContent.innerHTML += '<div style="color: #4caf50;">‚úì Connected to stream</div>';
                            break;
                            
                        case 'log':
                            currentResult.systemLogs.push(data.data);
                            streamingContent.innerHTML += `
                                <div class="log-entry ${data.data.level}" style="margin: 10px 0;">
                                    <span style="color: #888;">[${data.data.type}]</span> ${data.data.message}
                                </div>`;
                            break;
                            
                        case 'status':
                            statusText.textContent = data.data;
                            streamingContent.innerHTML += `<div style="color: #ff9800; margin: 10px 0;">‚è≥ ${data.data}</div>`;
                            break;
                            
                        case 'thinking':
                            currentResult.thinking.push(data.data);
                            // Don't show full thinking in streaming, just indicate it's happening
                            streamingContent.innerHTML += `<div style="color: #667eea; margin: 10px 0;">üí≠ Thinking step added...</div>`;
                            break;
                            
                        case 'response':
                            currentResult.response = data.data;
                            streamingContent.innerHTML += `
                                <div style="margin-top: 20px; padding: 15px; background: #252525; border-radius: 8px;">
                                    <h5 style="color: #4caf50; margin-bottom: 10px;">Model Response:</h5>
                                    <div style="white-space: pre-wrap; word-wrap: break-word;">${escapeHtml(data.data)}</div>
                                </div>`;
                            // Auto-scroll to show new content
                            streamingContent.scrollIntoView({ behavior: 'smooth', block: 'end' });
                            break;
                            
                        case 'workflow_log':
                            streamingContent.innerHTML += `<div style="color: #888; font-size: 0.9em; margin: 5px 0;">üìã ${escapeHtml(data.data)}</div>`;
                            break;
                            
                        case 'complete':
                            eventSource.close();
                            Object.assign(currentResult, data.data);
                            statusDot.className = 'status-dot active';
                            statusText.textContent = 'Complete';
                            
                            // Show final summary
                            streamingContent.innerHTML += `
                                <div style="margin-top: 20px; padding: 15px; background: #1a1a1a; border: 2px solid #4caf50; border-radius: 8px;">
                                    <h5 style="color: #4caf50;">‚úÖ Test Complete</h5>
                                    <p>Response time: ${data.data.responseTime}ms</p>
                                    <p>Tokens used: ${data.data.tokensUsed || 'N/A'}</p>
                                    <p>Model answer: ${data.data.modelAnswer || 'Could not extract'}</p>
                                    <p>Correct: ${data.data.correct ? '‚úì' : '‚úó'}</p>
                                </div>`;
                            
                            // Update tabs to show full results
                            displayLogContent();
                            break;
                            
                        case 'error':
                            eventSource.close();
                            statusDot.className = 'status-dot error';
                            statusText.textContent = 'Error';
                            streamingContent.innerHTML += `
                                <div style="margin-top: 20px; padding: 15px; background: #1a1a1a; border: 2px solid #f44336; border-radius: 8px;">
                                    <h5 style="color: #f44336;">‚ùå Error</h5>
                                    <p>${escapeHtml(data.data)}</p>
                                </div>`;
                            break;
                    }
                };
                
                eventSource.onerror = (error) => {
                    console.error('SSE error:', error);
                    eventSource.close();
                    statusDot.className = 'status-dot error';
                    statusText.textContent = 'Stream Error';
                };
                
                // Store results
                testResults[selectedQuestion.id] = result;
                
                // Update UI
                statusDot.className = result.error ? 'status-dot error' : 'status-dot active';
                statusText.textContent = result.error ? 'Error' : 'Complete';
                
                // Display results
                displayLogContent();
                
            } catch (error) {
                console.error('Test error:', error);
                console.error('Error stack:', error.stack);
                statusDot.className = 'status-dot error';
                statusText.textContent = 'Error';
                
                logContent.innerHTML += `
                    <div class="log-entry error">
                        <span class="log-timestamp">${new Date().toLocaleTimeString()}</span>
                        Error: ${error.message}
                    </div>
                    <div class="log-entry error">
                        <pre>${error.stack}</pre>
                    </div>
                `;
            } finally {
                testButton.disabled = false;
            }
        }

        // Utility function to escape HTML
        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', initializeUI);
    </script>
</body>
</html>